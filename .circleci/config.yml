version: 2.1

parameters:
  terraform-plan-file:
    type: string
    default: 'circleci.tfplan'

executors:
  terraform:
    docker:
      - image: hashicorp/terraform:<< parameters.tag >>
    parameters:
      tag:
        default: 1.3.7
        description: Specify the Terraform Docker image tag for the executor
        type: string
  base:
    docker:
      - image: cimg/base:current
  machine:
    machine:
      image: ubuntu-2204:2023.02.1

jobs:
  run:
    executor: machine
    steps:
      - checkout
      - run:
          name: spin up Telegraf container via Docker Compose
          command: |
            docker-compose up -d
      - run: sleep 30
      - run: docker logs telegraf

workflows:
  main:
    jobs:
      - run
